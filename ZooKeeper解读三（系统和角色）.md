title: ZooKeeper解读三（系统和角色）
date: 2015-07-29 15:53:48
tags: ZooKeeper
---

# ZooKeeper解读三（系统和角色）

标签（空格分隔）： 云计算-ZooKeeper

---

##1、系统架构

zookeeper分为服务器端（server）和客户端（client），客户端可以连接到整个zookeeper服务的任何服务器上（除非leaderServers参数被显示设置，leader不允许接收客户端连接）。客户端使用并维护一个TCP连接，通过这个连接发送请求，接受响应，获取观察的事件以及发送心跳。如果这个TCP连接中断，客户端自动尝试连接到另外的zookeeper服务器。客户端第一次连接到zookeeper服务时，接受这个连接的zookeeper服务器会为这个客户端建立一个会话。当这个客户端连接到另外的服务器时，这个会话会被新的服务器重新建立。

在org.apache.zookeeper.Watcher中定义了Event.KeeperState类型，用于表示client和server之间的状态，包括：
```java
/** Unused, this state is never generated by the server */
@Deprecated
Unknown (-1),

/** The client is in the disconnected state - it is not connected
 * to any server in the ensemble. */
Disconnected (0),

/** Unused, this state is never generated by the server */
@Deprecated
NoSyncConnected (1),

/** The client is in the connected state - it is connected
 * to a server in the ensemble (one of the servers specified
 * in the host connection parameter during ZooKeeper client
 * creation). */
SyncConnected (3),

/**
 * Auth failed state
 */
AuthFailed (4),

/**
 * The client is connected to a read-only server, that is the
 * server which is not currently connected to the majority.
 * The only operations allowed after receiving this state is
 * read operations.
 * This state is generated for read-only clients only since
 * read/write clients aren't allowed to connect to r/o servers.
 */
ConnectedReadOnly (5),

/**
  * SaslAuthenticated: used to notify clients that they are SASL-authenticated,
  * so that they can perform Zookeeper actions with their SASL-authorized permissions.
  */
SaslAuthenticated(6),

/** The serving cluster has expired this session. The ZooKeeper
 * client connection (the session) is no longer valid. You must
 * create a new client connection (instantiate a new ZooKeeper
 * instance) if you with to access the ensemble. */
Expired (-112);
```

需要注意session机制。client连接server成功后，server赋予该client一个sessionid。client需要不断发送心跳维持session有效，在session有效期内，可以使用zookeeper提供的API进行操作。如果因为某些原因导致client无法正常发送心跳，在超时时长后，server会判断该client的session失效，此时client发送的任何操作都会被拒绝，并触发ExpiredException异常，此时KeeperState处于Expired状态。

但client有自动重连server的机制，如果client的心跳无法正常连接server，会在session超时前尝试连接其他server，连接成功后可以继续操作。

如果client取消当前连接并连接其他server，已存在的watches会丢失，取而代之的是client会生成一个特殊WatchEvent告诉本地watcher连接已经丢失，该WatchEvent是：EventType.None，KeeperState.DisConnected。**本地watcher接收到该WatchEvent后会怎样？**

##2、server角色
启动zookeeper服务器集群环境后，多个zookeeper服务器在工作前会选举出一个Leader。选举出Leader前，所有server不区分角色，都需要平等参与投票（observer除外，不参与投票）；选主过程完成后，存在以下几种角色：
- leader：领导者，可以接受client请求，也接受其他server转发的写请求，负责更新系统状态。
- follower：可以接收client请求，如果是写请求将转发给leader来更新系统zhuangtai。
- observer：同follower，唯一区别就是不参与选主过程。

`org.apache.zookeeper.quorum.QuorumPeer`定义了server的类型，其中ServerState表示server类型，leanerType表示当ServerState为FOLLOWING时是参与者还是观察者，前者称为follower，后者称为observer。

```java
public enum ServerState {
    LOOKING, FOLLOWING, LEADING, OBSERVING;
}
    
/*
 * A peer can either be participating, which implies that it is willing to
 * both vote in instances of consensus and to elect or become a Leader, or
 * it may be observing in which case it isn't.
 * 
 * We need this distinction to decide which ServerState to move to when 
 * conditions change (e.g. which state to become after LOOKING). 
 */
public enum LearnerType {
    PARTICIPANT, OBSERVER;
}
    
/*
 * To enable observers to have no identifier, we need a generic identifier
 * at least for QuorumCnxManager. We use the following constant to as the
 * value of such a generic identifier. 
 */
```





